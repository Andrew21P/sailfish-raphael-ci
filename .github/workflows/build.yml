#=================================================
# Sailfish OS CI Build for Xiaomi Mi 9T Pro (raphael)
# Based on sailfish-on-davinci project structure
# Uses hybris-18.1 (Android 11) for SM8150
#=================================================

name: Build SailfishOS for raphael

on: 
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      name:
        description: 'trigger to build'
        required: true
        default: 'run'

permissions:
  contents: write

env:
  DEVICE: raphael
  VENDOR: xiaomi
  ANDROID_ROOT: /home/runner/work/sailfish-raphael-ci/sailfish-raphael-ci/hadk_18.1
  SAILFISH_SDK_VERSION: 5.0.0.43
  SAILFISH_OS_VERSION: 5.0.0.71

jobs:
  #=================================================
  # Job 1: Sync Android sources and cache
  #=================================================
  prep-source:
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 20480
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-android: 'true'
          remove-docker-images: 'true'

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Repo Tool & Source
        id: cache-android
        uses: actions/cache@v4
        with:
          path: |
            ~/bin/repo
            ${{ env.ANDROID_ROOT }}/.repo
          key: ${{ runner.os }}-android-repo-hybris18-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-android-repo-hybris18-

      - name: Download repo bin
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          git config --global user.email "ci@github.com"
          git config --global user.name "Github Actions"

      - name: Repo Sync hybris-18.1
        run: |
          mkdir -p $ANDROID_ROOT
          cd $ANDROID_ROOT
          # Use official mer-hybris manifest for hybris-18.1 (Android 11)
          python3 ~/bin/repo init -u https://github.com/mer-hybris/android.git -b hybris-18.1 --depth=1
          python3 ~/bin/repo sync -j$(nproc --all) -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync

  #=================================================
  # Job 2: Build Android HAL
  #=================================================
  build-hal:
    needs: prep-source
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 30720
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-android: 'true'
          remove-docker-images: 'true'

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore Repo Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/bin/repo
            ${{ env.ANDROID_ROOT }}/.repo
          key: ${{ runner.os }}-android-repo-hybris18-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-android-repo-hybris18-

      - name: Prepare Environment & Build
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-8-jdk android-tools-adb bc bison \
            build-essential curl flex g++-multilib gcc-multilib gnupg gperf \
            imagemagick lib32ncurses-dev lib32readline-dev lib32z1-dev \
            liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev \
            libxml2 libxml2-utils lzop pngcrush rsync schedtool \
            squashfs-tools xsltproc yasm zip zlib1g-dev \
            qemu-user-static qemu-system-arm e2fsprogs simg2img \
            libtinfo5 libncurses5 gzip virtualenv git python2

          # Setup JDK
          export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64/
          export PATH=$JAVA_HOME/bin:$PATH

          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          git config --global user.email "ci@github.com"
          git config --global user.name "Github Actions"
          git config --global --add safe.directory '*'

          # Create directory and sync from cache
          mkdir -p $ANDROID_ROOT
          cd $ANDROID_ROOT
          
          # If .repo exists from cache, use local sync; otherwise full init+sync
          if [ -d ".repo" ]; then
            echo "Cache found, running local checkout..."
            python3 ~/bin/repo sync -l -j$(nproc --all) || python3 ~/bin/repo sync -j$(nproc --all) -c --no-clone-bundle --no-tags
          else
            echo "No cache, running full init+sync..."
            python3 ~/bin/repo init -u https://github.com/mer-hybris/android.git -b hybris-18.1 --depth=1
            python3 ~/bin/repo sync -j$(nproc --all) -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync
          fi

          #------------------------------------------
          # Clone device-specific repos for raphael
          # Using PixelExperience repos (have aosp_raphael.mk target)
          # ALL URLS VERIFIED 2026-02-18
          #------------------------------------------
          # Device tree (PixelExperience eleven branch) - VERIFIED - has aosp_raphael.mk
          rm -rf $ANDROID_ROOT/device/xiaomi/raphael || true
          git clone https://github.com/PixelExperience-Devices/device_xiaomi_raphael.git \
            $ANDROID_ROOT/device/xiaomi/raphael --depth=1 -b eleven

          # Kernel (PixelExperience eleven branch) - VERIFIED
          rm -rf $ANDROID_ROOT/kernel/xiaomi/raphael || true
          git clone https://github.com/PixelExperience-Devices/kernel_xiaomi_raphael.git \
            $ANDROID_ROOT/kernel/xiaomi/raphael --depth=1 -b eleven

          # Hardware Xiaomi (LineageOS - used by PE too)
          rm -rf $ANDROID_ROOT/hardware/xiaomi || true
          git clone https://github.com/LineageOS/android_hardware_xiaomi.git \
            -b lineage-18.1 $ANDROID_ROOT/hardware/xiaomi --depth=1 --single-branch || true

          # Qualcomm Display HAL (critical for SM8150/Adreno 640) - VERIFIED
          rm -rf $ANDROID_ROOT/hardware/qcom-caf/sm8150/display || true
          mkdir -p $ANDROID_ROOT/hardware/qcom-caf/sm8150
          git clone https://github.com/LineageOS/android_hardware_qcom_display.git \
            -b lineage-18.1-caf-sm8150 $ANDROID_ROOT/hardware/qcom-caf/sm8150/display --depth=1

          # Qualcomm Audio HAL (SM8150) - VERIFIED
          rm -rf $ANDROID_ROOT/hardware/qcom-caf/sm8150/audio || true
          git clone https://github.com/LineageOS/android_hardware_qcom_audio.git \
            -b lineage-18.1-caf-sm8150 $ANDROID_ROOT/hardware/qcom-caf/sm8150/audio --depth=1

          # Qualcomm Media HAL (SM8150) - VERIFIED  
          rm -rf $ANDROID_ROOT/hardware/qcom-caf/sm8150/media || true
          git clone https://github.com/LineageOS/android_hardware_qcom_media.git \
            -b lineage-18.1-caf-sm8150 $ANDROID_ROOT/hardware/qcom-caf/sm8150/media --depth=1

          #------------------------------------------
          # Create vendor stubs (minimal for hybris-hal)
          #------------------------------------------
          mkdir -p $ANDROID_ROOT/vendor/xiaomi/raphael
          {
            echo '# Stub vendor makefile for hybris build'
            echo 'PRODUCT_SOONG_NAMESPACES += vendor/xiaomi/raphael'
          } > $ANDROID_ROOT/vendor/xiaomi/raphael/raphael-vendor.mk
          
          {
            echo '// Stub Android.bp for hybris build'
            echo 'soong_namespace {'
            echo '}'
          } > $ANDROID_ROOT/vendor/xiaomi/raphael/Android.bp
          
          echo '# Stub BoardConfig for hybris' > $ANDROID_ROOT/vendor/xiaomi/raphael/BoardConfigVendor.mk

          #------------------------------------------
          # Patch device tree for hybris compatibility
          #------------------------------------------
          # Fix kernel path (PE uses kernel/xiaomi/raphael, not sm8150)
          if [ -f "$ANDROID_ROOT/device/xiaomi/raphael/BoardConfig.mk" ]; then
            sed -i 's|kernel/xiaomi/sm8150|kernel/xiaomi/raphael|g' \
              $ANDROID_ROOT/device/xiaomi/raphael/BoardConfig.mk || true
          fi
          
          # Remove lineage fingerprint inscreen dependency (causes build error)
          sed -i '/vendor.lineage.biometrics.fingerprint.inscreen/d' \
            $ANDROID_ROOT/device/xiaomi/raphael/device.mk || true
          sed -i '/XiaomiParts/d' \
            $ANDROID_ROOT/device/xiaomi/raphael/device.mk || true

          #------------------------------------------
          # Replace hybris-boot with fixup-mountpoints
          #------------------------------------------
          rm -rf $ANDROID_ROOT/hybris/hybris-boot || true
          git clone https://github.com/mer-hybris/hybris-boot.git \
            $ANDROID_ROOT/hybris/hybris-boot --depth=1

          #------------------------------------------
          # Inject raphael fixup-mountpoints
          #------------------------------------------
          FIXUP_FILE="$ANDROID_ROOT/hybris/hybris-boot/fixup-mountpoints"
          if [ -f "$FIXUP_FILE" ] && ! grep -q '"raphael"' "$FIXUP_FILE"; then
            # Create raphael fixup content
            cat > /tmp/raphael_fixups.txt << 'EOF'
          "raphael"|"raphaelin")
              # Xiaomi Mi 9T Pro - SM8150 - Verified 2025-02-17
              sed -i \
                  -e 's block/bootdevice/by-name/boot sde49 ' \
                  -e 's block/bootdevice/by-name/recovery sda28 ' \
                  -e 's block/bootdevice/by-name/dtbo sde45 ' \
                  -e 's block/bootdevice/by-name/system sde54 ' \
                  -e 's block/bootdevice/by-name/vendor sde53 ' \
                  -e 's block/bootdevice/by-name/userdata sda31 ' \
                  -e 's block/bootdevice/by-name/cache sda29 ' \
                  -e 's block/bootdevice/by-name/persist sda23 ' \
                  -e 's block/bootdevice/by-name/misc sda11 ' \
                  -e 's block/bootdevice/by-name/modem sde52 ' \
                  -e 's block/bootdevice/by-name/dsp sde48 ' \
                  -e 's block/bootdevice/by-name/bluetooth sde26 ' \
                  -e 's block/bootdevice/by-name/vbmeta sde10 ' \
                  -e 's block/bootdevice/by-name/vbmeta_system sde47 ' \
                  -e 's block/bootdevice/by-name/abl sde17 ' \
                  -e 's block/bootdevice/by-name/xbl sdb2 ' \
                  -e 's block/bootdevice/by-name/xbl_config sdb1 ' \
                  -e 's block/bootdevice/by-name/tz sde19 ' \
                  -e 's block/bootdevice/by-name/hyp sde21 ' \
                  -e 's block/bootdevice/by-name/keymaster sde31 ' \
                  -e 's block/bootdevice/by-name/cmnlib sde27 ' \
                  -e 's block/bootdevice/by-name/cmnlib64 sde29 ' \
                  -e 's block/bootdevice/by-name/devcfg sde33 ' \
                  -e 's block/bootdevice/by-name/qupfw sde35 ' \
                  -e 's block/bootdevice/by-name/storsec sde37 ' \
                  -e 's block/bootdevice/by-name/modemst1 sdf2 ' \
                  -e 's block/bootdevice/by-name/modemst2 sdf3 ' \
                  -e 's block/bootdevice/by-name/fsc sdf5 ' \
                  -e 's block/bootdevice/by-name/fsg sdf1 ' \
                  -e 's block/bootdevice/by-name/aop sde11 ' \
                  -e 's block/bootdevice/by-name/cust sda30 ' \
                  -e 's block/bootdevice/by-name/logo sde46 ' \
                  -e 's block/bootdevice/by-name/splash sda19 ' \
                  -e 's block/bootdevice/by-name/keystore sda20 ' \
                  -e 's block/bootdevice/by-name/frp sda21 ' \
                  -e 's block/bootdevice/by-name/logfs sda18 ' \
                  -e 's block/bootdevice/by-name/devinfo sda7 ' \
                  -e 's block/bootdevice/by-name/product sde55 ' \
                  -e 's block/bootdevice/by-name/metadata sda19 ' \
                  -e 's block/by-name/metadata sda19 ' \
                  "$@"
              ;;
          EOF
            # Fix indentation for fixup-mountpoints (needs 4-space indent)
            sed -i 's/^          /    /' /tmp/raphael_fixups.txt
            # Insert before *)
            sed -i '/^[[:space:]]*\*)$/e cat /tmp/raphael_fixups.txt' "$FIXUP_FILE" || {
              head -n -20 "$FIXUP_FILE" > /tmp/fixup_temp
              cat /tmp/raphael_fixups.txt >> /tmp/fixup_temp
              tail -20 "$FIXUP_FILE" >> /tmp/fixup_temp
              mv /tmp/fixup_temp "$FIXUP_FILE"
            }
            echo "Added raphael to fixup-mountpoints"
          fi

          #------------------------------------------
          # Clean up ROM-specific dependencies for hybris
          #------------------------------------------
          # Remove problematic PE/LineageOS-specific stuff
          rm -rf device/xiaomi/raphael/XiaomiParts || true
          rm -rf device/xiaomi/raphael/parts || true
          rm -rf device/xiaomi/raphael/fod || true
          
          # Remove aosp.dependencies to avoid pulling more repos
          rm -f device/xiaomi/raphael/aosp.dependencies || true
          rm -f device/xiaomi/raphael/lineage.dependencies || true

          #------------------------------------------
          # Clone droidmedia
          #------------------------------------------
          rm -rf external/droidmedia || true
          git clone --recurse-submodules https://github.com/sailfishos/droidmedia.git external/droidmedia
          cd external/droidmedia
          git checkout 0.20230605.1 || true
          echo 'MINIMEDIA_AUDIOPOLICYSERVICE_ENABLE := 1' > env.mk
          echo 'AUDIOPOLICYSERVICE_ENABLE := 1' >> env.mk

          #------------------------------------------
          # Clone libhybris
          #------------------------------------------
          cd $ANDROID_ROOT/external
          rm -rf libhybris || true
          git clone --recurse-submodules https://github.com/mer-hybris/libhybris.git

          #------------------------------------------
          # Apply hybris-patches
          #------------------------------------------
          cd $ANDROID_ROOT
          hybris-patches/apply-patches.sh --mb || true

          #------------------------------------------
          # Build HAL
          #------------------------------------------
          sudo ln -sf /usr/bin/python2.7 /usr/bin/python || true
          
          # CRITICAL: Only remove the specific problematic file, NOT the whole vendor/lineage
          # PATH_OVERRIDE_SOONG is in vendor/lineage/build/soong/Android.bp
          rm -f vendor/lineage/build/soong/Android.bp || true
          
          # Create stub envsetup.sh if missing
          mkdir -p vendor/lineage/build
          if [ ! -f vendor/lineage/build/envsetup.sh ]; then
            echo 'function fixup_common_out_dir() { :; }' > vendor/lineage/build/envsetup.sh
          fi
          
          # Create vendor/aosp stubs for PE device tree
          mkdir -p vendor/aosp/build vendor/aosp/config
          echo 'function fixup_common_out_dir() { :; }' > vendor/aosp/build/envsetup.sh
          {
            echo '# Stub for hybris build'
            echo '$(call inherit-product, $(SRC_TARGET_DIR)/product/aosp_base_telephony.mk)'
          } > vendor/aosp/config/common_full_phone.mk
          
          #------------------------------------------
          # CREATE ALL CC_DEFAULTS STUBS RIGHT BEFORE BUILD
          # Comprehensive list to avoid endless fixing
          #------------------------------------------
          echo "Creating cc_defaults stubs for hybris build..."
          
          # Create a ROOT LEVEL stub file - soong scans all .bp files from root
          {
            echo '// Comprehensive cc_defaults stubs for hybris-18.1 build'
            echo '// Based on vendor/lineage and vendor/aosp soong modules'
            echo ''
            # Core defaults
            echo 'cc_defaults { name: "bootloader_message_offset_defaults", }'
            echo 'cc_defaults { name: "vold_hw_fde_defaults", }'
            echo 'cc_defaults { name: "vold_hw_fde_perf_defaults", }'
            echo 'cc_defaults { name: "process_sdk_version_overrides_defaults", }'
            echo 'cc_defaults { name: "shim_libs_defaults", }'
            echo 'cc_defaults { name: "has_memfd_backport_defaults", }'
            echo 'cc_defaults { name: "lineage_go_defaults", }'
            echo 'cc_defaults { name: "target_fs_config_gen_defaults", }'
            echo 'cc_defaults { name: "sdclang_defaults", }'
            echo 'cc_defaults { name: "libhidl_defaults", }'
            echo 'cc_defaults { name: "vendor_init_defaults", }'
            # Qcom specific
            echo 'cc_defaults { name: "stagefright_qcom_legacy_defaults", }'
            echo 'cc_defaults { name: "librmnetctl_pre_uplink_defaults", }'
            echo 'cc_defaults { name: "disable_postrender_cleanup_defaults", }'
            echo 'cc_defaults { name: "surfaceflinger_qcom_ext_defaults", }'
            echo 'cc_defaults { name: "legacy_hw_disk_encryption_defaults", }'
            echo 'cc_defaults { name: "qti_cryptfshw_qsee_defaults", }'
            echo 'cc_defaults { name: "qti_camera_device_defaults", }'
            echo 'cc_defaults { name: "qti_usb_hal_supported_modes_defaults", }'
            echo 'cc_defaults { name: "extended_compress_format_defaults", }'
            echo 'cc_defaults { name: "qti_kernel_headers_defaults", }'
            echo 'cc_defaults { name: "generated_kernel_includes", }'
            # Camera defaults
            echo 'cc_defaults { name: "camera_needs_client_info_defaults", }'
            echo 'cc_defaults { name: "camera_needs_client_info_lib_defaults", }'
            echo 'cc_defaults { name: "camera_parameter_library_defaults", }'
            echo 'cc_defaults { name: "no_cameraserver_defaults", }'
            echo 'cc_defaults { name: "camera_in_mediaserver_defaults", }'
            echo 'cc_defaults { name: "needs_camera_boottime", }'
            echo 'cc_defaults { name: "needs_camera_boottime_defaults", }'
            # Display/graphics defaults
            echo 'cc_defaults { name: "gralloc_10_usage_bits_defaults", }'
            echo 'cc_defaults { name: "surfaceflinger_fod_lib_defaults", }'
            echo 'cc_defaults { name: "surfaceflinger_udfps_lib_defaults", }'
            # Network defaults
            echo 'cc_defaults { name: "needs_netd_direct_connect_rule_defaults", }'
            echo 'cc_defaults { name: "ignores_ftp_pptp_conntrack_failure", }'
            # Misc defaults
            echo 'cc_defaults { name: "target_uses_prebuilt_dynamic_partitions_defaults", }'
            echo 'cc_defaults { name: "nvidia_enhancements_defaults", }'
            echo 'cc_defaults { name: "inputdispatcher_skip_event_key_defaults", }'
          } > /tmp/hybris_stubs.bp
          
          echo "Created hybris_stubs.bp with all cc_defaults"
          cat /tmp/hybris_stubs.bp

          # Put stubs in ONLY ONE place - device tree
          # Soong scans ALL Android.bp files globally, so modules only need to exist once
          mkdir -p device/xiaomi/raphael
          cp /tmp/hybris_stubs.bp device/xiaomi/raphael/Android.bp
          echo "Stubs placed in device/xiaomi/raphael/Android.bp ONLY"
          
          # Source the build environment
          set +e
          source build/envsetup.sh 2>&1
          set -e
          
          # Try lunch, fallback to manual TARGET setup
          if ! lunch aosp_raphael-userdebug 2>/dev/null; then
            echo "lunch failed, setting up environment manually..."
            export TARGET_PRODUCT=aosp_raphael
            export TARGET_BUILD_VARIANT=userdebug
            export TARGET_BUILD_TYPE=release
            export OUT_DIR=out
          fi

          # Free space
          rm -rf .repo || true

          make -j$(nproc --all) hybris-hal droidmedia || make -j$(nproc --all) hybris-boot

      - name: Upload HAL Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hal-output
          path: |
            ${{ env.ANDROID_ROOT }}/out/target/product/${{ env.DEVICE }}/hybris-boot.img
            ${{ env.ANDROID_ROOT }}/out/target/product/${{ env.DEVICE }}/droidmedia*.tgz
            ${{ env.ANDROID_ROOT }}/out/target/product/${{ env.DEVICE }}/obj/PACKAGING/
            ${{ env.ANDROID_ROOT }}/out/target/product/${{ env.DEVICE }}/system/
            ${{ env.ANDROID_ROOT }}/out/target/product/${{ env.DEVICE }}/root/
            ${{ env.ANDROID_ROOT }}/out/target/product/${{ env.DEVICE }}/recovery/
            ${{ env.ANDROID_ROOT }}/out/target/product/${{ env.DEVICE }}/*.img
          retention-days: 14

  #=================================================
  # Job 3: Build DHD (RPM packages)
  #=================================================
  build-dhd:
    needs: build-hal
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download HAL Artifacts
        uses: actions/download-artifact@v4
        with:
          name: hal-output
          path: ${{ env.ANDROID_ROOT }}/out/target/product/${{ env.DEVICE }}/

      - name: Build DHD in Docker container
        run: |
          cd $ANDROID_ROOT
          rm -rf .repo || true

          #------------------------------------------
          # Copy local RPM packaging repos (from checked-out workspace)
          #------------------------------------------
          WORKSPACE=${{ github.workspace }}
          
          # hybris-installer from ginkgo (for mkbootfs, etc.)
          git clone https://github.com/sailfish-on-ginkgo/hybris-installer.git \
            $ANDROID_ROOT/hybris/hybris-installer || true

          # Copy droid-hal-raphael (contains HAL packaging)
          mkdir -p $ANDROID_ROOT/rpm
          cp -r $WORKSPACE/droid-hal-raphael/* $ANDROID_ROOT/rpm/
          cd $ANDROID_ROOT/rpm
          git init && git add -A && git commit -m "init" || true
          # Clone the dhd submodule
          git clone https://github.com/mer-hybris/droid-hal-device.git $ANDROID_ROOT/rpm/dhd --depth=1

          # Copy droid-config-raphael (contains sparse overlays, patterns)
          mkdir -p $ANDROID_ROOT/hybris/droid-configs
          cp -r $WORKSPACE/droid-config-raphael/* $ANDROID_ROOT/hybris/droid-configs/
          cd $ANDROID_ROOT/hybris/droid-configs
          git init && git add -A && git commit -m "init" || true
          # Clone the droid-configs-device submodule
          git clone https://github.com/mer-hybris/droid-hal-configs.git $ANDROID_ROOT/hybris/droid-configs/droid-configs-device --depth=1

          # Copy droid-hal-version-raphael
          mkdir -p $ANDROID_ROOT/hybris/droid-hal-version-raphael
          cp -r $WORKSPACE/droid-hal-version-raphael/* $ANDROID_ROOT/hybris/droid-hal-version-raphael/
          cd $ANDROID_ROOT/hybris/droid-hal-version-raphael
          git init && git add -A && git commit -m "init" || true
          # Clone the droid-hal-version submodule
          git clone https://github.com/mer-hybris/droid-hal-version.git $ANDROID_ROOT/hybris/droid-hal-version-raphael/rpm/droid-hal-version --depth=1

          #------------------------------------------
          # Setup Docker workspace
          #------------------------------------------
          sudo mkdir -p /home/runner/work/sailfish-raphael-ci/sailfish-raphael-ci/docker

          #------------------------------------------
          # Copy helpers scripts
          #------------------------------------------
          cd ${{ github.workspace }}
          chmod +x build-rpm.sh || true
          chmod +x helpers/*.sh || true

          #------------------------------------------
          # Run DHD build in Docker
          #------------------------------------------
          sudo docker run --privileged \
            -v /home/runner/work:/home/mersdk/work \
            coderus/sailfishos-platform-sdk:$SAILFISH_SDK_VERSION \
            /bin/sh /home/mersdk/work/sailfish-raphael-ci/sailfish-raphael-ci/build-rpm.sh

      - name: Upload SailfishOS ZIP
        uses: actions/upload-artifact@v4
        with:
          name: sailfishos-zip
          path: |
            ${{ env.ANDROID_ROOT }}/SailfishOScommunity-*/sailfishos-*.zip
            ${{ env.ANDROID_ROOT }}/SailfishOS-*/sailfishos-*.zip
            ${{ env.ANDROID_ROOT }}/SailfishOScommunity-*/*.zip
            ${{ env.ANDROID_ROOT }}/SailfishOS-*/*.zip

      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ${{ env.ANDROID_ROOT }}/SailfishOScommunity-*/*-${{ env.DEVICE }}*.zip
            ${{ env.ANDROID_ROOT }}/SailfishOS-*/*-${{ env.DEVICE }}*.zip
