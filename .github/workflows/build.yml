#=================================================
# Build SailfishOS for Xiaomi Mi 9T Pro (raphael)
# Single job: HAL + DHD in same runner (needs Android tree for both)
#=================================================

name: Build SailfishOS for Raphael

on: 
  push:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: write

env:
  DEVICE: raphael
  VENDOR: xiaomi
  ANDROID_ROOT: /mnt/build/hadk_17.1
  SAILFISH_SDK_VERSION: 5.0.0.43

jobs:
  build-all:
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-android: 'true'
          remove-docker-images: 'true'
          build-mount-path: '/mnt/build'

      - name: Aggressive disk cleanup
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/boost /usr/share/swift /usr/local/.ghcup
          sudo rm -rf /opt/az /opt/microsoft /opt/google
          sudo rm -rf /usr/local/graalvm /usr/local/share/chromium /usr/local/share/powershell
          sudo rm -rf /usr/share/miniconda /usr/share/az_*
          sudo apt-get autoremove -y
          sudo apt-get clean
          echo "=== After cleanup ==="
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-8-jdk android-tools-adb bc bison \
            build-essential curl flex g++-multilib gcc-multilib gnupg gperf \
            imagemagick lib32ncurses-dev \
            lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev \
            libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc yasm zip zlib1g-dev \
            qemu-user-static qemu-system-arm e2fsprogs simg2img \
            libtinfo5 libncurses5 gzip virtualenv git python2
          sudo ln -sf /usr/bin/python2.7 /usr/bin/python
          
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          git config --global user.email "ci@github.com"
          git config --global user.name "Github Actions"

      - name: Repo sync hybris-17.1
        run: |
          mkdir -p $ANDROID_ROOT
          cd $ANDROID_ROOT
          python3 ~/bin/repo init -u https://github.com/mer-hybris/android.git -b hybris-17.1 --depth=1
          python3 ~/bin/repo sync -j$(nproc --all) -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync
          
          echo "=== After repo sync ==="
          df -h

      - name: Clone device repos
        run: |
          cd $ANDROID_ROOT
          
          # Device repos for raphael (SM8150 / Snapdragon 855) - LineageOS with lineage-17.1
          git clone https://github.com/LineageOS/android_device_xiaomi_raphael.git -b lineage-17.1 device/xiaomi/raphael --depth=1 || true
          git clone https://github.com/LineageOS/android_device_xiaomi_sm8150-common.git -b lineage-17.1 device/xiaomi/sm8150-common --depth=1 || true
          git clone https://github.com/LineageOS/android_kernel_xiaomi_sm8150.git -b lineage-17.1 kernel/xiaomi/sm8150 --depth=1 || true
          git clone https://github.com/LineageOS/android_hardware_xiaomi.git -b lineage-17.1 hardware/xiaomi --depth=1 || true
          
          # Vendor blobs - stub for HAL build (vendor not required for hybris-hal)
          mkdir -p vendor/xiaomi/raphael vendor/xiaomi/sm8150-common
          touch vendor/xiaomi/raphael/Android.bp vendor/xiaomi/sm8150-common/Android.bp
          
          # Hybris boot with fixup (mer-hybris official repos)
          rm -rf hybris/hybris-boot
          git clone https://github.com/mer-hybris/hybris-boot.git hybris/hybris-boot --depth=1 || true
          cp ${{ github.workspace }}/fixup-mountpoints hybris/hybris-boot/ || true
          
          # DHD repos - hybris-installer (mer-hybris official)
          git clone https://github.com/mer-hybris/hybris-installer.git hybris/hybris-installer --depth=1 || {
            mkdir -p hybris/hybris-installer
            touch hybris/hybris-installer/Android.mk
          }
          
          # Your custom DHD repos
          git clone --recurse-submodules https://github.com/Andrew21P/droid-hal-raphael.git rpm --depth=1
          git clone --recurse-submodules https://github.com/Andrew21P/droid-config-raphael.git hybris/droid-configs --depth=1
          git clone --recurse-submodules https://github.com/Andrew21P/droid-hal-version-raphael.git hybris/droid-hal-version-$DEVICE --depth=1
          
          # List what was cloned
          echo "=== Cloned repos ==="
          ls -la device/xiaomi/ kernel/xiaomi/ hardware/ hybris/ || true
          
          # Cleanup problematic packages
          find device/xiaomi -name "*.mk" -exec sed -i '/WfdCommon/d' {} \; 2>/dev/null || true
          find device/xiaomi -name "*.mk" -exec sed -i '/BluetoothQti/d' {} \; 2>/dev/null || true

      - name: Build HAL
        run: |
          cd $ANDROID_ROOT
          
          export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64/
          export PATH=$JAVA_HOME/bin:$PATH
          export SKIP_SOONG_TESTS=true
          
          # droidmedia
          rm -rf external/droidmedia
          git clone --recurse-submodules https://github.com/sailfishos/droidmedia.git external/droidmedia
          cd external/droidmedia && git checkout 0.20230605.1
          echo 'MINIMEDIA_AUDIOPOLICYSERVICE_ENABLE := 1' > env.mk
          echo 'AUDIOPOLICYSERVICE_ENABLE := 1' >> env.mk
          
          cd $ANDROID_ROOT/external
          git clone --recurse-submodules https://github.com/mer-hybris/libhybris.git || true
          
          cd $ANDROID_ROOT
          hybris-patches/apply-patches.sh --mb || true
          
          source build/envsetup.sh
          breakfast $DEVICE || lunch lineage_$DEVICE-userdebug || true
          
          # Delete .repo to free space before build
          rm -rf .repo
          df -h
          
          make -j$(nproc --all) hybris-hal droidmedia
          
          echo "=== HAL Build outputs ==="
          ls -lh out/target/product/$DEVICE/*.img 2>/dev/null || true

      - name: Build DHD RPMs
        run: |
          # Copy hadk.env and build scripts
          cp ${{ github.workspace }}/hadk.env $ANDROID_ROOT/
          cp ${{ github.workspace }}/helpers/*.sh $ANDROID_ROOT/rpm/dhd/helpers/
          chmod +x $ANDROID_ROOT/rpm/dhd/helpers/*.sh
          
          # Update hadk.env with correct path
          sed -i "s|/home/runner/work/ci/ci/hadk_17.1|$ANDROID_ROOT|g" $ANDROID_ROOT/hadk.env
          
          # Skip kernel config check (kernel already built)
          sed -i '/mer_verify_kernel_config/,/\.config$/d' $ANDROID_ROOT/rpm/dhd/droid-hal-device.inc
          sed -i 's/echo Verifying kernel config/echo "SKIP kernel check"/' $ANDROID_ROOT/rpm/dhd/droid-hal-device.inc
          
          # Create build script for container
          cat > /tmp/build-dhd.sh << 'BUILDSCRIPT'
          #!/bin/bash
          set -x
          
          export ANDROID_ROOT=/home/mersdk/android
          export VENDOR=xiaomi
          export DEVICE=raphael
          export PORT_ARCH=aarch64
          export SAILFISH_VERSION=5.0.0.43
          
          cd ~/.scratchbox2
          cp -R SailfishOS-*-$PORT_ARCH $VENDOR-$DEVICE-$PORT_ARCH 2>/dev/null || true
          cd $VENDOR-$DEVICE-$PORT_ARCH 2>/dev/null || true
          sed -i "s/SailfishOS-$SAILFISH_VERSION/$VENDOR-$DEVICE/g" sb2.config 2>/dev/null || true
          
          sudo ln -sf /srv/mer/targets/SailfishOS-$SAILFISH_VERSION-$PORT_ARCH /srv/mer/targets/$VENDOR-$DEVICE-$PORT_ARCH 2>/dev/null || true
          sudo ln -sf /srv/mer/toolings/SailfishOS-$SAILFISH_VERSION /srv/mer/toolings/$VENDOR-$DEVICE 2>/dev/null || true
          
          sb2 -t $VENDOR-$DEVICE-$PORT_ARCH -m sdk-install -R chmod 777 /boot 2>/dev/null || true
          
          cd $ANDROID_ROOT
          git config --global user.email "ci@github.com"
          git config --global user.name "Github Actions"
          git config --global --add safe.directory '*'
          
          sudo mkdir -p /proc/sys/fs/binfmt_misc/
          sudo mount binfmt_misc -t binfmt_misc /proc/sys/fs/binfmt_misc 2>/dev/null || true
          
          chmod +x rpm/dhd/helpers/*.sh
          rpm/dhd/helpers/build_packages.sh || echo "DHD build completed with warnings"
          
          if [ -f droid-hal-$DEVICE.log ]; then
            tail -100 droid-hal-$DEVICE.log
          fi
          BUILDSCRIPT
          chmod +x /tmp/build-dhd.sh
          
          # Run in container
          docker pull coderus/sailfishos-platform-sdk:$SAILFISH_SDK_VERSION || docker pull coderus/sailfishos-platform-sdk:latest
          
          docker run --privileged \
            -v $ANDROID_ROOT:/home/mersdk/android \
            -v /tmp/build-dhd.sh:/home/mersdk/build-dhd.sh \
            coderus/sailfishos-platform-sdk:$SAILFISH_SDK_VERSION \
            /bin/bash /home/mersdk/build-dhd.sh || echo "Container exited"
          
          echo "=== DHD outputs ==="
          find $ANDROID_ROOT -name "*.rpm" 2>/dev/null | head -20 || true
          find $ANDROID_ROOT -name "sailfishos-*.zip" 2>/dev/null || true

      - name: Upload HAL
        uses: actions/upload-artifact@v4
        with:
          name: hal-output
          path: |
            ${{ env.ANDROID_ROOT }}/out/target/product/${{ env.DEVICE }}/hybris-boot.img
            ${{ env.ANDROID_ROOT }}/out/target/product/${{ env.DEVICE }}/hybris-recovery.img

      - name: Upload SailfishOS ZIP
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sailfishos-${{ env.DEVICE }}
          path: |
            ${{ env.ANDROID_ROOT }}/SailfishOScommunity-release-*/sailfishos-*.zip
            ${{ env.ANDROID_ROOT }}/droid-local-repo/
