#=================================================
# SailfishOS for Xiaomi Mi 9T Pro (raphael)
# Simple package job - reuses HAL from run 22110403799
#=================================================

name: Build SailfishOS for Raphael

on: 
  push:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: write

env:
  DEVICE: raphael
  HAL_RUN_ID: '22110403799'

jobs:
  package:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download HAL artifacts
        uses: actions/download-artifact@v4
        with:
          name: hal-output
          path: hal-output
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          run-id: ${{ env.HAL_RUN_ID }}

      - name: Create flashable package
        run: |
          mkdir -p sailfish-${{ env.DEVICE }}
          
          # Copy boot images
          cp hal-output/hybris-boot.img sailfish-${{ env.DEVICE }}/ 2>/dev/null || true
          cp hal-output/hybris-recovery.img sailfish-${{ env.DEVICE }}/ 2>/dev/null || true
          
          # Create flash script
          cat > sailfish-${{ env.DEVICE }}/flash.sh << 'EOF'
          #!/bin/bash
          echo "=== SailfishOS Flash Script for Xiaomi Mi 9T Pro (raphael) ==="
          echo ""
          echo "This will flash hybris-boot to test the SailfishOS kernel."
          echo ""
          echo "Prerequisites:"
          echo "1. Bootloader unlocked"
          echo "2. Device in fastboot mode (Power + Vol Down)"
          echo "3. Stock Android/Pixel Experience vendor partition intact"
          echo ""
          read -p "Press Enter to continue or Ctrl+C to cancel..."
          
          # Disable verity first
          echo "Disabling verified boot..."
          fastboot --disable-verity --disable-verification flash vbmeta vbmeta.img 2>/dev/null || \
            echo "vbmeta not found - you may need to disable verity manually"
          
          echo "Flashing hybris-boot..."
          fastboot flash boot hybris-boot.img
          
          echo ""
          echo "Done! Reboot with: fastboot reboot"
          echo ""
          echo "If device bootloops:"
          echo "  1. Boot to fastboot again"
          echo "  2. Flash back your original boot.img"
          echo ""
          echo "To see kernel output, run: adb shell dmesg"
          EOF
          chmod +x sailfish-${{ env.DEVICE }}/flash.sh
          
          # Create README
          cat > sailfish-${{ env.DEVICE }}/README.md << 'EOF'
          # SailfishOS Kernel Test for Xiaomi Mi 9T Pro (raphael)
          
          This is a **kernel test build** - not a full SailfishOS installation.
          
          ## What this contains
          - `hybris-boot.img` - Kernel with SailfishOS/hybris patches
          - `hybris-recovery.img` - Recovery image
          
          ## Flash Instructions
          
          1. **Backup your current boot image first!**
             ```
             adb reboot bootloader
             fastboot boot twrp.img  # or your recovery
             # In TWRP: backup boot partition
             ```
          
          2. **Flash hybris-boot**
             ```
             fastboot flash boot hybris-boot.img
             fastboot reboot
             ```
          
          3. **What to expect**
             - First boot: Device will likely show black screen or bootloop
             - This is NORMAL for first hybris kernel test
             - Connect via USB and check: `adb shell dmesg` or `adb logcat`
          
          ## If it doesn't boot
          - Boot to fastboot: Hold Power + Vol Down
          - Flash your backup boot.img
          - Report any serial output you captured
          
          ## Next Steps
          After kernel boots, we need to build the full SailfishOS rootfs.
          
          Based on hybris-17.1 (Android 10)
          Device: Xiaomi Mi 9T Pro (raphael) - SM8150 Snapdragon 855
          EOF
          
          ls -la sailfish-${{ env.DEVICE }}/

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: sailfish-${{ env.DEVICE }}-test
          path: sailfish-${{ env.DEVICE }}/
