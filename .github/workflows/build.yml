#=================================================
# Description: Build SailfishOS for Xiaomi Mi 9T Pro (raphael)
# Based on: sailfish-on-davinci/ci
# Author: Adapted for raphael
#=================================================

name: Build SailfishOS for Raphael

on: 
  push:
    branches:
      - master
      - main
  workflow_dispatch:
    inputs:
      name:
        description: 'trigger to build'
        required: true
        default: 'run'

permissions:
  contents: write

env:
  DEVICE: raphael
  VENDOR: xiaomi
  SAILFISH_SDK_VERSION: 5.0.0.43
  SAILFISH_OS_VERSION: 5.0.0.71

jobs:
  # Combined build job
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-android: 'true'
          remove-docker-images: 'true'
          build-mount-path: '/mnt/build'
          
      - name: Free Disk Space Aggressively
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/boost /usr/share/swift /usr/local/.ghcup
          sudo rm -rf /opt/az /opt/microsoft /opt/google
          sudo apt-get autoremove -y
          sudo apt-get clean
          echo "=== After cleanup ==="
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download repo bin
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          git config --global user.email "ci@github.com"
          git config --global user.name "Github Actions"

      - name: Repo Sync
        run: |
          export ANDROID_ROOT=/mnt/build/hadk_17.1
          mkdir -p $ANDROID_ROOT
          cd $ANDROID_ROOT
          python3 ~/bin/repo init -u https://github.com/mer-hybris/android.git -b hybris-17.1 --depth=1
          python3 ~/bin/repo sync -j$(nproc --all) -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-8-jdk android-tools-adb bc bison \
            build-essential curl flex g++-multilib gcc-multilib gnupg gperf \
            imagemagick lib32ncurses-dev \
            lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev \
            libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc yasm zip zlib1g-dev \
            qemu-user-static qemu-system-arm e2fsprogs simg2img \
            libtinfo5 libncurses5 gzip virtualenv git python2
          sudo ln -sf /usr/bin/python2.7 /usr/bin/python

      - name: Clone Device Repos & Build
        run: |
          export ANDROID_ROOT=/mnt/build/hadk_17.1
          
          # Clone device-specific repos for raphael (Mi 9T Pro / SM8150)
          # crDroid has Android 10 support (10.0 branch)
          git clone https://github.com/crdroidandroid/android_device_xiaomi_raphael.git -b 10.0 $ANDROID_ROOT/device/xiaomi/raphael --depth=1 || \
            git clone https://github.com/PixelExperience-Devices/device_xiaomi_raphael.git $ANDROID_ROOT/device/xiaomi/raphael --depth=1 || true
          
          # SM8150 common device tree from crDroid
          git clone https://github.com/crdroidandroid/android_device_xiaomi_sm8150-common.git -b 10.0 $ANDROID_ROOT/device/xiaomi/sm8150-common --depth=1 || true
          
          # Kernel - SM8150 (Snapdragon 855) from crDroid
          git clone https://github.com/crdroidandroid/android_kernel_xiaomi_sm8150.git -b 10.0 $ANDROID_ROOT/kernel/xiaomi/sm8150 --depth=1 || \
            git clone https://github.com/PixelExperience-Devices/kernel_xiaomi_sm8150.git $ANDROID_ROOT/kernel/xiaomi/sm8150 --depth=1 || true
          
          # Vendor blobs from TheMuppets
          git clone https://github.com/TheMuppets/proprietary_vendor_xiaomi.git -b lineage-17.1 $ANDROID_ROOT/vendor/xiaomi --depth=1 || true
          
          # Hybris boot with fixup-mountpoints for raphael
          rm -rf $ANDROID_ROOT/hybris/hybris-boot
          git clone https://github.com/Andrew21P/hybris-boot.git $ANDROID_ROOT/hybris/hybris-boot --depth=1 || \
            git clone https://github.com/mer-hybris/hybris-boot.git -b master $ANDROID_ROOT/hybris/hybris-boot --depth=1
          
          # Copy our fixup-mountpoints with raphael support
          cp ${{ github.workspace }}/fixup-mountpoints $ANDROID_ROOT/hybris/hybris-boot/
          
          # Hardware xiaomi
          git clone https://github.com/crdroidandroid/android_hardware_xiaomi.git -b 10.0 $ANDROID_ROOT/hardware/xiaomi --depth=1 || \
            git clone https://github.com/LineageOS/android_hardware_xiaomi.git -b lineage-17.1 $ANDROID_ROOT/hardware/xiaomi --depth=1 || true

          # Fix missing metalava directory
          mkdir -p $ANDROID_ROOT/tools/metalava/manual

          # Fix WfdCommon missing dex jar - remove WFD references that we don't need
          find $ANDROID_ROOT/device/xiaomi -name "*.mk" -exec sed -i 's/WfdCommon//g' {} \; 2>/dev/null || true
          find $ANDROID_ROOT/device/xiaomi -name "*.mk" -exec sed -i '/wfd/d' {} \; 2>/dev/null || true
          find $ANDROID_ROOT/vendor/xiaomi -name "*.mk" -exec sed -i 's/WfdCommon//g' {} \; 2>/dev/null || true
          
          # Remove problematic WFD packages from device.mk
          sed -i '/WfdCommon/d' $ANDROID_ROOT/device/xiaomi/raphael/device.mk 2>/dev/null || true
          sed -i '/WfdCommon/d' $ANDROID_ROOT/device/xiaomi/sm8150-common/common.mk 2>/dev/null || true
          sed -i '/WfdCommon/d' $ANDROID_ROOT/device/xiaomi/sm8150-common/device.mk 2>/dev/null || true
          
          # Also remove from Android.bp files
          find $ANDROID_ROOT/device/xiaomi -name "Android.bp" -exec sed -i '/WfdCommon/d' {} \; 2>/dev/null || true
          find $ANDROID_ROOT/vendor/xiaomi -name "Android.bp" -exec sed -i '/WfdCommon/d' {} \; 2>/dev/null || true
          
          # Search and remove WfdCommon from all possible locations
          grep -r "WfdCommon" $ANDROID_ROOT/device/ $ANDROID_ROOT/vendor/ $ANDROID_ROOT/hardware/ 2>/dev/null | head -20 || true
          find $ANDROID_ROOT -name "*.bp" -exec grep -l "WfdCommon" {} \; 2>/dev/null | while read f; do
            echo "Removing WfdCommon from $f"
            sed -i '/WfdCommon/d' "$f"
          done

          # Build
          cd $ANDROID_ROOT
          source build/envsetup.sh
          
          # Set ALLOW_MISSING_DEPENDENCIES for hybris builds (standard practice)
          export ALLOW_MISSING_DEPENDENCIES=true
          
          # Try different lunch targets
          breakfast raphael userdebug || \
            lunch aosp_raphael-userdebug || \
            lunch lineage_raphael-userdebug || true
          
          # Check if device tree was found
          ls -la $ANDROID_ROOT/device/xiaomi/raphael/ || echo "WARNING: Device tree not found!"
          
          make -j$(nproc --all) hybris-hal droidmedia || make -j$(nproc --all) hybris-boot hybris-recovery

      - name: Upload HAL Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hal-output
          path: |
            /mnt/build/hadk_17.1/out/target/product/${{ env.DEVICE }}/hybris-boot.img
            /mnt/build/hadk_17.1/out/target/product/${{ env.DEVICE }}/hybris-recovery.img
            /mnt/build/hadk_17.1/out/target/product/${{ env.DEVICE }}/system.img
            /mnt/build/hadk_17.1/out/target/product/${{ env.DEVICE }}/vendor.img
            /mnt/build/hadk_17.1/out/target/product/${{ env.DEVICE }}/*.prop
